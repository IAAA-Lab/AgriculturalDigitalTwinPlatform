FROM node:16 as landing-page
WORKDIR /usr/src/app
# Copy args to env
ARG REACT_APP_API_URL
ENV REACT_APP_API_URL=$REACT_APP_API_URL
ARG PORT
ENV PORT=$PORT
ARG REACT_APP_DIGITAL_TWIN_URL
ENV REACT_APP_DIGITAL_TWIN_URL=$REACT_APP_DIGITAL_TWIN_URL
ARG REACT_APP_EMAIL_SENDER_PUBKEY
ENV REACT_APP_EMAIL_SENDER_PUBKEY=$REACT_APP_EMAIL_SENDER_PUBKEY
ARG REACT_APP_EMAIL_SENDER_SERVICEID
ENV REACT_APP_EMAIL_SENDER_SERVICEID=$REACT_APP_EMAIL_SENDER_SERVICEID
ARG REACT_APP_EMAIL_SENDER_TEMPLATEID
ENV REACT_APP_EMAIL_SENDER_TEMPLATEID=$REACT_APP_EMAIL_SENDER_TEMPLATEID
COPY landing-page/package*.json ./
RUN yarn install
COPY landing-page/ ./
RUN yarn run build

FROM node:19 as digital-twin
WORKDIR /usr/src/app
# Copy args to env
ARG VITE_BASE_URL
ENV VITE_BASE_URL=$VITE_BASE_URL
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL
ARG VITE_SVELTE_PORT
ENV VITE_PORT=$VITE_SVELTE_PORT
ARG VITE_IV_BLOCK_PASSWD
ENV VITE_IV_BLOCK_PASSWD=$VITE_IV_BLOCK_PASSWD
ARG VITE_KEY_DECRYPT_PASSWD
ENV VITE_KEY_DECRYPT_PASSWD=$VITE_KEY_DECRYPT_PASSWD
ARG VITE_SERVER_URL
ENV VITE_SERVER_URL=$VITE_SERVER_URL
ARG VITE_LANDING_URL
ENV VITE_LANDING_URL=$VITE_LANDING_URL
ARG VITE_IMAGES_SERVER_URL
ENV VITE_IMAGES_SERVER_URL=$VITE_IMAGES_SERVER_URL
COPY digital-twin-panel/ ./
RUN yarn install && yarn run build

FROM node:19 as private-access
WORKDIR /usr/src/app
# Copy args to env
ARG VITE_VANILLAJS_PORT
ENV VITE_PORT=$VITE_VANILLAJS_PORT
ARG VITE_API_URL
ENV VITE_API_URL=$VITE_API_URL
ARG VITE_IV_BLOCK_PASSWD
ENV VITE_IV_BLOCK_PASSWD=$VITE_IV_BLOCK_PASSWD
ARG VITE_KEY_DECRYPT_PASSWD
ENV VITE_KEY_DECRYPT_PASSWD=$VITE_KEY_DECRYPT_PASSWD
ARG VITE_VANILLAJS_BASE_URL
ENV VITE_BASE_URL=$VITE_VANILLAJS_BASE_URL
COPY private-access/ ./
RUN yarn install && yarn run build

FROM nginx:1.23.3
EXPOSE 80
COPY nginx/nginx.conf /etc/nginx/conf.d/default.conf

COPY --from=landing-page /usr/src/app/build /usr/share/nginx/html/lp
COPY --from=digital-twin /usr/src/app/dist /usr/share/nginx/html/dtp
COPY --from=private-access /usr/src/app/dist /usr/share/nginx/html/pa
