FROM node:18.15.0 as build
WORKDIR /app
COPY . .
RUN yarn
# Get args
ARG VITE_PORT
ARG VITE_API_URL
ARG VITE_EMAIL_SENDER_PUBKEY
ARG VITE_EMAIL_SENDER_SERVICEID
ARG VITE_EMAIL_SENDER_TEMPLATEID
ARG VITE_IV_BLOCK_PASSWD
ARG VITE_KEY_DECRYPT_PASSWD
ARG VITE_IMAGES_SERVER_URL
# Set env
ENV VITE_PORT=$VITE_PORT
ENV VITE_API_URL=$VITE_API_URL
ENV VITE_EMAIL_SENDER_PUBKEY=$VITE_EMAIL_SENDER_PUBKEY
ENV VITE_EMAIL_SENDER_SERVICEID=$VITE_EMAIL_SENDER_SERVICEID
ENV VITE_EMAIL_SENDER_TEMPLATEID=$VITE_EMAIL_SENDER_TEMPLATEID
ENV VITE_IV_BLOCK_PASSWD=$VITE_IV_BLOCK_PASSWD
ENV VITE_KEY_DECRYPT_PASSWD=$VITE_KEY_DECRYPT_PASSWD
ENV VITE_IMAGES_SERVER_URL=$VITE_IMAGES_SERVER_URL
RUN yarn build

FROM node:18.15.0 as deply-node
WORKDIR /app
RUN rm -rf ./*
COPY --from=build /app/package.json .
COPY --from=build /app/build .
RUN yarn --prod
CMD ["node", "index.js"]