# Krakend Api Gateway with billing capabilities

This is the **Api Gateway** that serve private and public endpoints from some of the IAAA systems. It is powered by [Krakend](https://www.krakend.io/), a Go framework for building API Gateways, [RabbitMQ](https://www.rabbitmq.com/) for event-driven communication, [BuntDB](https://github.com/tidwall/buntdb), an embedded database for storing the customer's billing information and [Stripe](https://stripe.com/) for payment gateway.

## Getting Started

### Secrets

An env file is used to store the secrets. You can find an example in the `.env.example` file. You have to create a `.env` file in the root directory of the project and add the environment variables present in the `.env.example` file.

To use Stripe you need to create a Stripe account and use the Stripe api key in the `STRIPE_KEY` env variable. Then create a product and link the `product_price_id` to the `STRIPE_PRICE_ID` env variable to link a subscription to the product. You can find the `product_price_id` in the Stripe dashboard under the `Products` menu.

To use the email service, it is used the `net/smtp` package from Go. You need to provide the sender email and app password in the `EMAIL_SENDER_MAIL` and `EMAIL_SENDER_PASSWORD` env variables. The app password is the password generated by Google for the app using the *2-factor authentication*. You can find more information [here](https://support.google.com/accounts/answer/185833).


### Prerequisites

Everything is containerized, so you only need the following:

- [Docker](https://docs.docker.com/install/)
- [Docker Compose](https://docs.docker.com/compose/install/)

### Installing and Running

1. Clone the repository
2. Create a `.env` file in the root directory of the project and add the environment variables present in the `.env.example` file
3. Run `docker-compose up --build` to build the images and run the containers

## Usage

Once the containers are up and running, you can access the endpoints given in the `krakend.json` file. The endpoints are protected with the use of API keys. You have to get it by subscribing to a product with the use of the [Stripe Checkout](https://stripe.com/docs/payments/checkout) page. The API key will be sent to the email address you provided in the checkout page.

1. Once the stripe cli container is up and running, go to the address it tells and then allow the app to access your Stripe account locally. It will print it in the console. It is used to link the Stripe events to our local webhook endpoint `http://api-gateway/payment/webhook`. When it is done, a Stripe webhook secret will be printed in the console. Copy it and paste it in the `STRIPE_WEBHOOK_SECRET` env variable.
2. Go to the `http://api-gateway/payment/checkout` endpoint
3. Fill up the form and click the `Pay` button. You can use one of the test cards provided by Stripe [here](https://stripe.com/docs/testing#cards)
4. When the payment is successful, you will receive an email with the API key. You can now use it to access the endpoints.
5. You can access the `http://api-gateway/digital-twin/ping` endpoint to test if the API key is working. You will have to include the API key in the `Authorization` header. If the API key is valid, you will receive a `pong` response, otherwise, you will receive a `401 Unauthorized` response.

## Krakend http interceptors

The Krakend framework provides a way to intercept the http requests and responses. It is used to add the API key to the request headers and to check if the API key is valid. You can find more information [here](https://www.krakend.io/docs/extending/). In this case, we are using plugins to intercept the requests and responses, which are located in the `plugins` folder. They work as middlewares for **Api key validation** and **Payment event handling**.
